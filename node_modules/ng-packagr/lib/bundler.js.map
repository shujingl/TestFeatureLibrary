{"version":3,"file":"bundler.js","sourceRoot":"","sources":["../../src/lib/bundler.ts"],"names":[],"mappings":";;AACA,yCAA+C;AAC/C,mCAAmD;AACnD,2CAAiD;AACjD,yCAAwC;AACxC,mCAA+C;AAC/C,oCAAwC;AACxC,oCAA8C;AAE9C;;;;;;GAMG;AACU,QAAA,gBAAgB,GAAG,UAAC,KAAmB,EAAE,KAAgB,IAA2B,OAAA,OAAO,CAAC,OAAO,EAAE;KAE/G,IAAI,CAAC,cAAM,OAAA,sBAAa,CAAC,KAAK,CAAC,GAAG,EAAK,KAAK,CAAC,gBAAgB,QAAK,CAAC,EAAxD,CAAwD,CAAC;KAEpE,IAAI,CAAC,cAAM,OAAA,qBAAe,CAAC,KAAK,EAAK,KAAK,CAAC,gBAAgB,0BAAuB,CAAC;KACjF,IAAI,CAAC,UAAC,YAAoB,IAAK,OAAA,SAAG,CAAC,YAAY,EAAK,KAAK,CAAC,gBAAgB,QAAK,CAAC,EAAjD,CAAiD,CAAC;KACjF,IAAI,CAAC,UAAC,eAAuB;IAC5B,qEAAqE;IACrE,OAAA,wBAAc,CAAI,KAAK,CAAC,gBAAgB,YAAO,KAAK,CAAC,kBAAkB,QAAK,CAAC;SAC1E,IAAI,CAAC,cAAM,OAAA,OAAO,CAAC,OAAO,CAAC,eAAe,CAAC,EAAhC,CAAgC,CAAC;AAD/C,CAC+C,CAAC,EALxC,CAKwC,CACnD;KAEA,IAAI,CAAC,UAAC,eAAuB;IAC5B,OAAA,eAAM,CAAC;QACL,UAAU,EAAE,KAAK,CAAC,IAAI,CAAC,IAAI;QAC3B,KAAK,EAAE,eAAe;QACtB,MAAM,EAAE,IAAI;QACZ,IAAI,EAAK,KAAK,CAAC,gBAAgB,SAAI,KAAK,CAAC,SAAS,CAAC,MAAQ;QAC3D,SAAS,EAAE,KAAK,CAAC,YAAY;KAC9B,CAAC;SAGD,IAAI,CAAC,cAAM,OAAA,wBAAc,CAAI,KAAK,CAAC,gBAAgB,SAAI,KAAK,CAAC,SAAS,CAAC,MAAQ,CAAC,EAArE,CAAqE,CAAC;AATlF,CASkF,CACnF;KAEA,IAAI,CAAC;IACJ,OAAA,sBAAgB,CACX,KAAK,CAAC,gBAAgB,SAAI,KAAK,CAAC,SAAS,CAAC,MAAQ,EAClD,KAAK,CAAC,gBAAgB,SAAI,KAAK,CAAC,SAAS,CAAC,MAAQ,CAAC;SACvD,IAAI,CAAC,cAAM,OAAA,wBAAc,CAAI,KAAK,CAAC,gBAAgB,SAAI,KAAK,CAAC,SAAS,CAAC,MAAQ,CAAC,EAArE,CAAqE,CAAC;AAHlF,CAGkF,CACnF;KAEA,IAAI,CAAC;IACJ,OAAA,eAAM,CAAC;QACL,UAAU,EAAE,KAAK,CAAC,IAAI,CAAC,IAAI;QAC3B,KAAK,EAAK,KAAK,CAAC,gBAAgB,SAAI,KAAK,CAAC,SAAS,CAAC,MAAQ;QAC5D,MAAM,EAAE,KAAK;QACb,IAAI,EAAK,KAAK,CAAC,gBAAgB,SAAI,KAAK,CAAC,SAAS,CAAC,IAAM;QACzD,SAAS,EAAE,KAAK,CAAC,YAAY;KAC9B,CAAC;SACD,IAAI,CAAC,cAAM,OAAA,wBAAc,CAAI,KAAK,CAAC,gBAAgB,SAAI,KAAK,CAAC,SAAS,CAAC,IAAM,CAAC,EAAnE,CAAmE,CAAC;AAPhF,CAOgF,CACjF;KAEA,IAAI,CAAC,cAAM,OAAA,gBAAS,CAAI,KAAK,CAAC,gBAAgB,SAAI,KAAK,CAAC,IAAI,CAAC,KAAK,sBAAmB,EAAK,KAAK,CAAC,IAAI,SAAI,KAAK,CAAC,IAAI,CAAC,KAAO,CAAC,EAAhH,CAAgH,CAAC;KAC5H,IAAI,CAAC,cAAM,OAAA,gBAAS,CAAI,KAAK,CAAC,gBAAgB,8BAA2B,EAAK,KAAK,CAAC,IAAI,aAAU,CAAC,EAAxF,CAAwF,CAAC;KACpG,IAAI,CAAC,cAAM,OAAA,gBAAS,CAAI,KAAK,CAAC,gBAAgB,kCAA+B,EAAE,KAAG,KAAK,CAAC,IAAM,CAAC,EAApF,CAAoF,CAAC;KAGhG,IAAI,CAAC,cAAM,OAAA,sBAAe,CAAI,KAAK,CAAC,IAAI,iBAAc,EAAE,UAAC,SAAc;IACtE,SAAS,CAAC,SAAS,CAAC,GAAG,SAAS,CAAC,SAAS,CAAC;SACxC,GAAG,CAAC,UAAC,IAAY,IAAa,OAAA,IAAI,CAAC,OAAO,CAAC,OAAO,EACjD,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,OAAK,KAAK,CAAC,IAAI,CAAC,KAAK,SAAI,KAAK,CAAC,IAAI,CAAC,IAAM,CAAC,CAAC,CAAC,OAAK,KAAK,CAAC,IAAI,CAAC,IAAM,CAAC,EAD1D,CAC0D,CAAC,CAAC;IAE7F,MAAM,CAAC,SAAS,CAAC;AACnB,CAAC,CAAC,EANU,CAMV,CAAC;KAEF,IAAI,CAAC;IAEJ,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC;IACvB;;;;;;;;MAQE;AACJ,CAAC,CAAC,EApE6F,CAoE7F,CAAC","sourcesContent":["import { NgEntrypoint, NgArtefacts, NgPackage } from './model/ng-package';\nimport { processAssets } from './steps/assets';\nimport { prepareTsConfig, ngc } from './steps/ngc';\nimport { remapSourcemap } from './steps/sorcery';\nimport { rollup } from './steps/rollup';\nimport { downlevelWithTsc } from './steps/tsc';\nimport { copyFiles } from './util/copy';\nimport { modifyJsonFiles } from './util/json';\n\n/**\n * Main Angular bundling processing.\n *\n * @param entry A TypeScript source file (`*.ts`) of the bundle's entrypoint.\n * @param ngPkg Parent Angular package.\n * @returns Distribution-ready build artefacts.\n */\nexport const generateNgBundle = (entry: NgEntrypoint, ngPkg: NgPackage): Promise<NgArtefacts> => Promise.resolve()\n  // 1. ASSETS\n  .then(() => processAssets(ngPkg.src, `${ngPkg.workingDirectory}/ts`))\n  // 2. NGC\n  .then(() => prepareTsConfig(ngPkg, `${ngPkg.workingDirectory}/ts/tsconfig.lib.json`)\n    .then((tsConfigFile: string) => ngc(tsConfigFile, `${ngPkg.workingDirectory}/ts`))\n    .then((es2015EntryFile: string) =>\n      // XX: see #46 - ngc only references to closure-annotated ES6 sources\n      remapSourcemap(`${ngPkg.workingDirectory}/ts/${ngPkg.flatModuleFileName}.js`)\n        .then(() => Promise.resolve(es2015EntryFile)))\n  )\n  // 3. FESM15: ROLLUP\n  .then((es2015EntryFile: string) =>\n    rollup({\n      moduleName: ngPkg.meta.name,\n      entry: es2015EntryFile,\n      format: 'es',\n      dest: `${ngPkg.workingDirectory}/${ngPkg.artefacts.es2015}`,\n      externals: ngPkg.libExternals\n    })\n    // XX ... rollup generates relative paths in sourcemaps. It would be nice to re-locate source map files\n    // so that `@scope/name/foo/bar.ts` shows up as path in the browser...\n    .then(() => remapSourcemap(`${ngPkg.workingDirectory}/${ngPkg.artefacts.es2015}`))\n  )\n  // 4. FESM5: TSC\n  .then(() =>\n    downlevelWithTsc(\n      `${ngPkg.workingDirectory}/${ngPkg.artefacts.es2015}`,\n      `${ngPkg.workingDirectory}/${ngPkg.artefacts.module}`)\n    .then(() => remapSourcemap(`${ngPkg.workingDirectory}/${ngPkg.artefacts.module}`))\n  )\n  // 5. UMD: ROLLUP\n  .then(() =>\n    rollup({\n      moduleName: ngPkg.meta.name,\n      entry: `${ngPkg.workingDirectory}/${ngPkg.artefacts.module}`,\n      format: 'umd',\n      dest: `${ngPkg.workingDirectory}/${ngPkg.artefacts.main}`,\n      externals: ngPkg.libExternals\n    })\n    .then(() => remapSourcemap(`${ngPkg.workingDirectory}/${ngPkg.artefacts.main}`))\n  )\n  // 6. COPY FILES\n  .then(() => copyFiles(`${ngPkg.workingDirectory}/${ngPkg.meta.scope}/**/*.{js,js.map}`, `${ngPkg.dest}/${ngPkg.meta.scope}`))\n  .then(() => copyFiles(`${ngPkg.workingDirectory}/bundles/**/*.{js,js.map}`, `${ngPkg.dest}/bundles`))\n  .then(() => copyFiles(`${ngPkg.workingDirectory}/ts/**/*.{d.ts,metadata.json}`, `${ngPkg.dest}`))\n  // 7. SOURCEMAPS: RELOCATE PATHS\n  // XX ... modifyJsonFiles() should maybe called 'relocateSourceMaps()' in 'steps' folder\n  .then(() => modifyJsonFiles(`${ngPkg.dest}/**/*.js.map`, (sourceMap: any): any => {\n    sourceMap['sources'] = sourceMap['sources']\n      .map((path: string): string => path.replace('../ts',\n        ngPkg.meta.scope ? `~/${ngPkg.meta.scope}/${ngPkg.meta.name}` : `~/${ngPkg.meta.name}`));\n\n    return sourceMap;\n  }))\n  // 8. COLLECT GENERATED ARTEFACTS\n  .then(() => {\n\n    return ngPkg.artefacts;\n    /*\n    return {\n      main: '',\n      module: '',\n      es2015: '',\n      typings: '',\n      metadata: ''\n    };\n    */\n  });\n"]}